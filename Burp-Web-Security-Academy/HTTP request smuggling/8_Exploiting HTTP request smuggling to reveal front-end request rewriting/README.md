## Exploiting HTTP request smuggling to reveal front-end request rewriting
https://portswigger.net/web-security/request-smuggling/exploiting/lab-reveal-front-end-request-rewriting

## Phân tích
- Phát hiện là CL.TE
- Thử path /admin ==> request from 127.0.0.1 nghĩa là chỉ chấp nhận request từ máy local

![img.png](img.png)

- Trong trường hợp này, máy client (của chúng ta) chỉ truy cập từ internet, thông qua 1 hay nhiều proxy của server (nginx ...) nên ko thể nào kết nối đc bằng 127.0.0.1.
- Nghĩa ngay đến `X-Forwarded-For` header dưới đây (TL;DR)

  - "X-Forwarded-For" (XFF) là một tiêu chuẩn trong giao thức HTTP được sử dụng để xác định địa chỉ IP gốc của một khách hàng khi kết nối đến máy chủ web thông qua một hoặc nhiều máy chủ proxy.
  - Trong môi trường proxy, khi một yêu cầu HTTP đi qua các máy chủ proxy trước khi đến máy chủ đích, địa chỉ IP của khách hàng gốc thường bị che đi và chỉ hiển thị địa chỉ IP của máy chủ proxy cuối cùng. Điều này có thể làm mất đi thông tin quan trọng về địa chỉ IP người gửi yêu cầu ban đầu.
  - Dùng đầu vào "X-Forwarded-For" máy chủ web có thể biết được địa chỉ IP của khách hàng ban đầu và của các máy chủ proxy mà yêu cầu đã đi qua. Thông tin này hữu ích trong việc theo dõi và xác minh nguồn gốc của yêu cầu, đặc biệt là trong các môi trường sử dụng các dịch vụ proxy hoặc CDN (Content Delivery Network).

- Thử với `X-Forwarded-For`
![img_1.png](img_1.png)
--> có khả năng X-Forward-For đã bị override bởi 1 header nào đó trước khi forward xuống BE
--> ta đi tìm header này

- Thấy rằng, search function như sau
![img_2.png](img_2.png)
- Dùng smuggling để exploit search này
  - Attack req
![img_3.png](img_3.png)
  - Normal req (thấy letter G bất thường)
![img_4.png](img_4.png)
  - Tăng CL trong attack lên (e.g: 158)
![img_5.png](img_5.png)
![img_6.png](img_6.png)
    
- Booomm... - Bị replace bởi `X-ySaWdy-Ip: ` header
- Ok, vào resolve lab

## Resolve lab
- Send attack

![img_8.png](img_8.png)

- Send normal red
![img_7.png](img_7.png)

- Try with `/admin/delete?username=carlos`
![img_9.png](img_9.png)
![img_10.png](img_10.png)

Done

![img_11.png](img_11.png)